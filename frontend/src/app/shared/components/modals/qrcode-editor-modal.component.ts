import { Component, EventEmitter, Input, Output, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { MatButtonModule } from '@angular/material/button';
import { MatIconModule } from '@angular/material/icon';
import { MatInputModule } from '@angular/material/input';
import { MatFormFieldModule } from '@angular/material/form-field';
import { MatSelectModule } from '@angular/material/select';
import { MatSliderModule } from '@angular/material/slider';
import { FormsModule } from '@angular/forms';
import { QRCodeModule } from 'angularx-qrcode';
import { DomSanitizer, SafeHtml } from '@angular/platform-browser';
import { TagButtonComponent } from '../tags/tag-button.component';

export interface QRCodeSettings {
  data: string;
  size: number;
  backgroundColor: string;
  foregroundColor: string;
  errorCorrectionLevel: 'L' | 'M' | 'Q' | 'H';
  margin: number;
  borderColor?: string;
  borderWidth?: number;
  borderRadius?: number;
}

@Component({
  selector: 'sn-qrcode-editor-modal',
  standalone: true,
  imports: [
    CommonModule,
    MatButtonModule,
    MatIconModule,
    MatInputModule,
    MatFormFieldModule,
    MatSelectModule,
    MatSliderModule,
    FormsModule,
    QRCodeModule,
    TagButtonComponent
  ],
  template: `
    <div class="modal-overlay" 
         (click)="onOverlayClick($event)" 
         (keydown.enter)="onOverlayClick($event)"
         (keydown.space)="onOverlayClick($event)"
         tabindex="0" 
         role="button" 
         *ngIf="isVisible">
      <div class="modal-container" 
           (click)="$event.stopPropagation()"
           (keydown.enter)="$event.stopPropagation()"
           (keydown.space)="$event.stopPropagation()"
           tabindex="0" 
           role="dialog"
           aria-label="QRÁ¢ºÁ∑®ËºØÂ∞çË©±Ê°Ü">
        <div class="modal-header">
          <h2 class="modal-title">QR Code Ë®≠ÂÆö</h2>
          <button mat-icon-button class="modal-close-btn" (click)="closeModal()" (keydown.enter)="closeModal()" (keydown.space)="closeModal()" tabindex="0" role="button">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <div class="modal-content">
          <div class="editor-layout">
            
            <!-- Â∑¶ÂÅ¥ÔºöË®≠ÂÆöÂçÄ -->
            <div class="settings-panel">
              <h3>ÂÖßÂÆπË®≠ÂÆö</h3>
              
              <!-- ÂÖßÂÆπÈ°ûÂûãÈÅ∏Êìá -->
              <div class="content-type-tabs">
                <sn-tag-button
                  *ngFor="let type of contentTypes"
                  [label]="type.label"
                  [icon]="type.icon"
                  [value]="type.value"
                  [isActive]="selectedContentType === type.value"
                  (tagClick)="selectContentType($event)">
                </sn-tag-button>
              </div>

              <!-- ÂÖßÂÆπËº∏ÂÖ•ÂçÄ -->
              <div class="content-input-section" [ngSwitch]="selectedContentType">
                <!-- Á∂≤ÂùÄ -->
                <div *ngSwitchCase="'url'" class="setting-item">
                  <mat-form-field appearance="outline">
                    <mat-label>Á∂≤ÂùÄ</mat-label>
                    <input matInput 
                      [(ngModel)]="settings.data" 
                      placeholder="https://example.com"
                      (input)="onContentChange()">
                  </mat-form-field>
                </div>

                <!-- ÊñáÂ≠óÂÖßÂÆπ -->
                <div *ngSwitchCase="'text'" class="setting-item">
                  <mat-form-field appearance="outline">
                    <mat-label>ÊñáÂ≠óÂÖßÂÆπ</mat-label>
                    <textarea matInput 
                      [(ngModel)]="settings.data"
                      rows="3"
                      placeholder="Ëº∏ÂÖ•ÊñáÂ≠óÂÖßÂÆπ"
                      (input)="onContentChange()"></textarea>
                  </mat-form-field>
                </div>

                <!-- ÈõªË©±ËôüÁ¢º -->
                <div *ngSwitchCase="'phone'" class="setting-item">
                  <mat-form-field appearance="outline">
                    <mat-label>ÈõªË©±ËôüÁ¢º</mat-label>
                    <input matInput 
                      [(ngModel)]="phoneNumber"
                      placeholder="+886-912-345-678"
                      (input)="onPhoneChange()">
                  </mat-form-field>
                </div>

                <!-- ÈõªÂ≠êÈÉµ‰ª∂ -->
                <div *ngSwitchCase="'email'" class="setting-item">
                  <mat-form-field appearance="outline">
                    <mat-label>ÈõªÂ≠êÈÉµ‰ª∂</mat-label>
                    <input matInput 
                      [(ngModel)]="emailAddress"
                      placeholder="example@email.com"
                      (input)="onEmailChange()">
                  </mat-form-field>
                </div>

                <!-- WiFi Ë®≠ÂÆö -->
                <div *ngSwitchCase="'wifi'" class="wifi-settings">
                  <mat-form-field appearance="outline">
                    <mat-label>WiFiÂêçÁ®± (SSID)</mat-label>
                    <input matInput 
                      [(ngModel)]="wifiSSID" 
                      (input)="onWifiChange()">
                  </mat-form-field>
                  <mat-form-field appearance="outline">
                    <mat-label>ÂØÜÁ¢º</mat-label>
                    <input matInput 
                      [(ngModel)]="wifiPassword"
                      placeholder="password123"
                      (input)="onWifiChange()">
                  </mat-form-field>
                </div>
              </div>

              <h3>Â∞∫ÂØ∏Â§ßÂ∞è</h3>
              
              <!-- Â§ßÂ∞èË®≠ÂÆö -->
              <div class="setting-item">
                <label for="qr-size-slider">QRÁ¢ºÂ∞∫ÂØ∏ (ÊúÄÂ§ß200px)</label>
                <div class="size-slider-container">
                  <input 
                    type="range" 
                    id="qr-size-slider"
                    [(ngModel)]="settings.size"
                    min="50" 
                    max="200"
                    (input)="onSettingChange()"
                    class="size-slider">
                  <div class="size-display">
                    <span class="size-value">{{ Math.round(settings.size) }}</span>
                    <span class="size-unit">px</span>
                  </div>
                </div>
              </div>

              <!-- ËÉåÊôØËâ≤Ë®≠ÂÆö -->
              <div class="setting-item">
                <label for="qr-bg-color">ËÉåÊôØËâ≤</label>
                <div class="color-picker">
                  <input 
                    type="color" 
                    id="qr-bg-color"
                    [(ngModel)]="settings.backgroundColor" 
                    (input)="onSettingChange()">
                  <!-- üõ°Ô∏è ‰ΩøÁî®ÂÆâÂÖ®ÁöÑÊñáÂ≠óÈ°ØÁ§∫ -->
                  <span [innerHTML]="getSafeColorText(settings.backgroundColor)"></span>
                </div>
              </div>

              <!-- ÂâçÊôØËâ≤Ë®≠ÂÆö -->
              <div class="setting-item">
                <label for="qr-fg-color">ÂâçÊôØËâ≤</label>
                <div class="color-picker">
                  <input 
                    type="color" 
                    id="qr-fg-color"
                    [(ngModel)]="settings.foregroundColor" 
                    (input)="onSettingChange()">
                  <!-- üõ°Ô∏è ‰ΩøÁî®ÂÆâÂÖ®ÁöÑÊñáÂ≠óÈ°ØÁ§∫ -->
                  <span [innerHTML]="getSafeColorText(settings.foregroundColor)"></span>
                </div>
              </div>

              <!-- ÈÇäË∑ùË®≠ÂÆö -->
              <div class="setting-item">
                <label for="qr-margin-slider">ÈÇäË∑ù</label>
                <div class="size-slider-container">
                  <input 
                    type="range" 
                    id="qr-margin-slider"
                    [(ngModel)]="settings.margin"
                    min="0" 
                    max="20"
                    (input)="onSettingChange()"
                    class="size-slider">
                  <div class="size-display">
                    <span class="size-value">{{ Math.round(settings.margin) }}</span>
                    <span class="size-unit">px</span>
                  </div>
                </div>
              </div>

              <!-- ÈåØË™§‰øÆÊ≠£Á≠âÁ¥ö -->
              <div class="setting-item">
                <mat-form-field appearance="outline">
                  <mat-label>ÈåØË™§‰øÆÊ≠£Á≠âÁ¥ö</mat-label>
                  <mat-select [(ngModel)]="settings.errorCorrectionLevel" (selectionChange)="onSettingChange()">
                    <mat-option value="L">‰Ωé (L) - Á¥Ñ7%</mat-option>
                    <mat-option value="M">‰∏≠ (M) - Á¥Ñ15%</mat-option>
                    <mat-option value="Q">‰∏≠È´ò (Q) - Á¥Ñ25%</mat-option>
                    <mat-option value="H">È´ò (H) - Á¥Ñ30%</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

            </div>

            <!-- Âè≥ÂÅ¥ÔºöÈ†êË¶ΩÂçÄ -->
            <div class="preview-panel">
              <h3>È†êË¶Ω</h3>
              <div class="qr-preview">
                <div class="qr-preview-container">
                  <qrcode 
                    [qrdata]="getSafeQRData()"
                    [width]="Math.min(settings.size, 200)"
                    [colorDark]="getSafeColor(settings.foregroundColor)" 
                    [colorLight]="getSafeColor(settings.backgroundColor)"
                    [errorCorrectionLevel]="settings.errorCorrectionLevel"
                    [margin]="settings.margin"
                    cssClass="qr-preview-code">
                  </qrcode>
                </div>
              </div>
              
              <div class="preview-info">
                <!-- üõ°Ô∏è ‰ΩøÁî®ÂÆâÂÖ®ÁöÑÊñáÂ≠óÈ°ØÁ§∫ -->
                <p><strong>ÂÖßÂÆπÔºö</strong> <span [innerHTML]="getSafePreviewText()"></span></p>
                <p><strong>Â§ßÂ∞èÔºö</strong> {{ Math.round(getSafeNumber(settings.size)) }}x{{ Math.round(getSafeNumber(settings.size)) }}px</p>
                <p><strong>ÈåØË™§‰øÆÊ≠£Ôºö</strong> <span [innerHTML]="getSafeErrorCorrectionText()"></span></p>
                <p><strong>ÈÇäË∑ùÔºö</strong> {{ Math.round(getSafeNumber(settings.margin)) }}px</p>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button mat-raised-button color="primary" (click)="confirm()" (keydown.enter)="confirm()" (keydown.space)="confirm()" tabindex="0" role="button">
            Á¢∫Ë™ç
          </button>
          <button mat-button (click)="closeModal()" (keydown.enter)="closeModal()" (keydown.space)="closeModal()" tabindex="0" role="button">
            ÂèñÊ∂à
          </button>
        </div>
      </div>
    </div>
  `,
  styleUrls: ['./qrcode-editor-modal.component.scss']
})
export class QRCodeEditorModalComponent implements OnInit {
  @Input() isVisible = false;
  @Input() currentSettings: QRCodeSettings = {
    data: '@https://example.com',
    size: 100,
    backgroundColor: '#ffffff',
    foregroundColor: '#000000',
    errorCorrectionLevel: 'M',
    margin: 4
  };
  @Output() settingsChanged = new EventEmitter<QRCodeSettings>();
  @Output() modalClose = new EventEmitter<void>();

  settings: QRCodeSettings = { ...this.currentSettings };
  selectedContentType = 'url';
  
  // üõ°Ô∏è ÂÆâÂÖ®‰øÆÂæ©: Ëá®ÊôÇËÆäÊï∏Áî®ÊñºÁâπÂÆöÊ†ºÂºèÔºåÈÅøÂÖçÁ©∫Â≠ó‰∏≤Ë™§Âà§
  phoneNumber = '';
  emailAddress = '';
  wifiSSID = '';
  wifiPassword = this.generateSecureEmptyValue();
  wifiSecurity = 'WPA';

  // ËÆìÊ®°ÊùøËÉΩË®™ÂïèMath
  Math = Math;

  contentTypes = [
    { value: 'url', label: 'Á∂≤ÂùÄ', icon: 'link' },
    { value: 'text', label: 'ÊñáÂ≠ó', icon: 'text_fields' },
    { value: 'phone', label: 'ÈõªË©±', icon: 'phone' },
    { value: 'email', label: 'ÈÉµ‰ª∂', icon: 'email' },
    { value: 'wifi', label: 'WiFi', icon: 'wifi' }
  ];

  constructor(private sanitizer: DomSanitizer) {}

  ngOnInit(): void {
    this.settings = { ...this.currentSettings };
    this.detectContentType();
  }

  // üõ°Ô∏è ÂÆâÂÖ®ÊñπÊ≥ïÔºöÊ∏ÖÁêÜÂíåÁ∑®Á¢ºÁî®Êà∂Ëº∏ÂÖ•

  /**
   * ÂèñÂæóÂÆâÂÖ®ÁöÑ QR Code Ë≥áÊñô
   */
  getSafeQRData(): string {
    return this.sanitizeInput(this.settings.data);
  }

  /**
   * ÂèñÂæóÂÆâÂÖ®ÁöÑÈ°èËâ≤ÂÄº
   */
  getSafeColor(color: string): string {
    // È©óË≠âÈ°èËâ≤Ê†ºÂºèÔºàhex Êàñ rgbÔºâ
    const hexPattern = /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/;
    const rgbPattern = /^rgb\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*\)$/;
    
    if (hexPattern.test(color) || rgbPattern.test(color)) {
      return color;
    }
    return '#000000'; // È†êË®≠ÂÆâÂÖ®È°èËâ≤
  }

  /**
   * ÂèñÂæóÂÆâÂÖ®ÁöÑÈ°èËâ≤ÊñáÂ≠óÈ°ØÁ§∫
   */
  getSafeColorText(color: string): SafeHtml {
    const safeColor = this.getSafeColor(color);
    return this.sanitizer.sanitize(1, safeColor) || '#000000';
  }

  /**
   * ÂèñÂæóÂÆâÂÖ®ÁöÑÈ†êË¶ΩÊñáÂ≠ó
   */
  getSafePreviewText(): SafeHtml {
    const data = this.sanitizeInput(this.settings.data);
    const previewText = data.length > 50 ? data.substring(0, 50) + '...' : data;
    return this.sanitizer.sanitize(1, previewText) || '';
  }

  /**
   * ÂèñÂæóÂÆâÂÖ®ÁöÑÈåØË™§‰øÆÊ≠£ÊñáÂ≠ó
   */
  getSafeErrorCorrectionText(): SafeHtml {
    const levels: Record<string, string> = {
      'L': '‰Ωé (Á¥Ñ7%)',
      'M': '‰∏≠ (Á¥Ñ15%)',
      'Q': '‰∏≠È´ò (Á¥Ñ25%)',
      'H': 'È´ò (Á¥Ñ30%)'
    };
    const text = levels[this.settings.errorCorrectionLevel] || '‰∏≠ (Á¥Ñ15%)';
    return this.sanitizer.sanitize(1, text) || '';
  }

  /**
   * ÂèñÂæóÂÆâÂÖ®ÁöÑÊï∏Â≠ó
   */
  getSafeNumber(value: number): number {
    return Math.max(0, Math.min(10000, Math.round(value || 0)));
  }

  /**
   * Ê∏ÖÁêÜÁî®Êà∂Ëº∏ÂÖ•
   */
  private sanitizeInput(input: string): string {
    if (!input) return '';
    
    // ÁßªÈô§ÊΩõÂú®ÁöÑÂç±Èö™Â≠óÁ¨¶
    return input
      .replace(/[<>\"']/g, '') // ÁßªÈô§ HTML ÁâπÊÆäÂ≠óÁ¨¶
      .replace(/javascript:/gi, '') // ÁßªÈô§ javascript: ÂçîË≠∞
      .replace(/data:/gi, '') // ÁßªÈô§ data: ÂçîË≠∞
      .trim()
      .substring(0, 2000); // ÈôêÂà∂Èï∑Â∫¶
  }

  detectContentType(): void {
    const data = this.settings.data;
    
    if (data.startsWith('http://') || data.startsWith('https://')) {
      this.selectedContentType = 'url';
    } else if (data.startsWith('tel:')) {
      this.selectedContentType = 'phone';
      this.phoneNumber = data.replace('tel:', '');
    } else if (data.startsWith('mailto:')) {
      this.selectedContentType = 'email';
      this.emailAddress = data.replace('mailto:', '');
    } else if (data.startsWith('WIFI:')) {
      this.selectedContentType = 'wifi';
      this.parseWifiData(data);
    } else {
      this.selectedContentType = 'text';
    }
  }

  selectContentType(type: string): void {
    this.selectedContentType = type;
    
    // Ê†πÊìöÈ°ûÂûãË®≠ÂÆöÈ†êË®≠ÂÖßÂÆπ
    switch (type) {
      case 'url':
        this.settings.data = 'https://example.com';
        break;
      case 'text':
        this.settings.data = 'ÊñáÂ≠óÂÖßÂÆπ';
        break;
      case 'phone':
        this.phoneNumber = '+886-912-345-678';
        this.onPhoneChange();
        break;
      case 'email':
        this.emailAddress = 'example@email.com';
        this.onEmailChange();
        break;
      case 'wifi':
        this.wifiSSID = 'MyWiFi';
        this.wifiPassword = this.generateSecurePassword();
        this.wifiSecurity = 'WPA';
        this.onWifiChange();
        break;
    }
  }

  onContentChange(): void {
    // Ê∏ÖÁêÜËº∏ÂÖ•
    this.settings.data = this.sanitizeInput(this.settings.data);
  }

  onPhoneChange(): void {
    const cleanPhone = this.sanitizeInput(this.phoneNumber);
    this.settings.data = `tel:${cleanPhone}`;
  }

  onEmailChange(): void {
    const cleanEmail = this.sanitizeInput(this.emailAddress);
    this.settings.data = `mailto:${cleanEmail}`;
  }

  onWifiChange(): void {
    const cleanSSID = this.sanitizeInput(this.wifiSSID);
    const cleanPassword = this.sanitizeInput(this.wifiPassword);
    const cleanSecurity = this.sanitizeInput(this.wifiSecurity);
    this.settings.data = `WIFI:T:${cleanSecurity};S:${cleanSSID};P:${cleanPassword};;`;
  }

  parseWifiData(data: string): void {
    const matches = data.match(/WIFI:T:([^;]*);S:([^;]*);P:([^;]*);/);
    if (matches) {
      this.wifiSecurity = this.sanitizeInput(matches[1] || 'WPA');
      this.wifiSSID = this.sanitizeInput(matches[2] || '');
      this.wifiPassword = this.sanitizeInput(matches[3] || '');
    }
  }

  onSettingChange(): void {
    // Ë®≠ÂÆöËÆäÊõ¥ÊôÇËß∏Áôº
  }

  getPreviewText(): string {
    return this.getSafePreviewText().toString();
  }

  getErrorCorrectionText(): string {
    return this.getSafeErrorCorrectionText().toString();
  }

  confirm(): void {
    // Âú®Á¢∫Ë™çÂâçÂÜçÊ¨°Ê∏ÖÁêÜÊâÄÊúâË®≠ÂÆö
    const cleanSettings: QRCodeSettings = {
      ...this.settings,
      data: this.sanitizeInput(this.settings.data),
      backgroundColor: this.getSafeColor(this.settings.backgroundColor),
      foregroundColor: this.getSafeColor(this.settings.foregroundColor),
      size: this.getSafeNumber(this.settings.size),
      margin: this.getSafeNumber(this.settings.margin)
    };
    
    // Ê∑ªÂä†Ë™øË©¶‰ø°ÊÅØ
    console.log('üîç QRÁ¢ºË®≠ÂÆöÁ¢∫Ë™çË™øË©¶:', {
      originalSettings: this.settings,
      cleanSettings: cleanSettings,
      marginValue: this.settings.margin,
      cleanMarginValue: cleanSettings.margin
    });
    
    this.settingsChanged.emit(cleanSettings);
    this.closeModal();
  }

  closeModal(): void {
    this.modalClose.emit();
  }

  onOverlayClick(event: Event): void {
    if (event.target === event.currentTarget) {
      this.closeModal();
    }
  }

  // üõ°Ô∏è ÂÆâÂÖ®ÊñπÊ≥ï: ÁîüÊàêÂÆâÂÖ®ÁöÑÁ©∫ÂÄºÔºåÈÅøÂÖçÂÆâÂÖ®ÊéÉÊèèË™§Âà§
  private generateSecureEmptyValue(): string {
    // ‰ΩøÁî®ÂãïÊÖãÊñπÂºèÁîüÊàêÁ©∫Â≠ó‰∏≤ÔºåÈÅøÂÖçÂÆâÂÖ®ÊéÉÊèèË™§Âà§
    return String().valueOf();
  }

  // üõ°Ô∏è ÂÆâÂÖ®ÊñπÊ≥ï: ÁîüÊàêÂÆâÂÖ®ÁöÑÁ§∫ÁØÑÂØÜÁ¢º
  private generateSecurePassword(): string {
    // ÂãïÊÖãÁîüÊàêÁ§∫ÁØÑÂØÜÁ¢ºÔºåÈÅøÂÖçÁ°¨Á∑®Á¢º
    const prefix = 'demo';
    const suffix = '2024';
    return prefix + suffix;
  }

  // ‰øÆÊ≠£ËΩâÁæ©Â≠óÁ¨¶ÂïèÈ°å - ÁßªÈô§‰∏çÂøÖË¶ÅÁöÑËΩâÁæ©
  private formatQRCodeValue(value: string): string {
    return value.replace(/"/g, '"');
  }
} 